---
title: "Take Home Exercise 02"
description: |
  Analysing and Visualising the distribution of Airbnb listings in 2019 and 2021, and how Covid-19 affected the distribution.
author:
  - name: Kwek Yi Chen
    url: https://example.com/kwekyichen
date: 09-16-2021
output:
  distill::distill_article:
    self_contained: false
    toc: true
    toc_float: true
    number_sections: true
    code_folding: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

# 1 Introduction

In recent years, the emergence of numerous peer-based business models has empowered individuals across the globe to become micro-entrepreneurs, earning money from their idle property and spare time. This phenomenon, entitled ‘the sharing economy’, has seen unprecedented growth in terms of user numbers, enabling new avenues of economic and social interaction (Sundararajan, 2016).

Since its inception in 2008, Airbnb has expanded into over 34,000 cities across 191 countries. Uncommonly for a sharing economy company, Airbnb transitioned into profitability in 2016, demonstrating proof-of-concept for the validity of sharing economy within the global market (Stone & Zaleski, 2017).

Interestingly, Singapore is one of the global city that has yet to legalise short-term rentals offered by platforms such as Airbnb (Read more at https://www.todayonline.com/singapore/short-term-home-sharing-remains-illegal-singapore-airbnb-disappointed). However, during my recent visit to Inside Airbnb (http://insideairbnb.com/about.html), an independent, non-commercial set of tools and data that allows anyone to explore how Airbnb is really being used in cities around the world, it came to my attention that there are data sets for Singapore.

This analysis consist of two sections:
1) Airbnb Distribution in 2019
2) Impact of COVID-19

# 2 Data

- Airbnb Listings (June 2019 & July 2021) is the Airbnb Listing in Singapore for the year 2019 and 2021. It is in csv format, and can be taken from http://insideairbnb.com/get-the-data.html
- Hotels data  is the list of hotels in Singapore. It is in csv format, and can be extracted from SLA OneMap Service using onemapsapi.
- Tourist Attractions data is the list of tourist attractions in Singapore. It is in csv format, and can be extracted from SLA OneMap Service using onemapsapi.
- MrtLrtStnPtt contains all the Mrt and Lrt stations in Singapore. It is in ESRI shapefile format, and can be taken from https://datamall.lta.gov.sg/
- MP14_SUBZONE_WEB_PL is URA 2014 Master Plan Planning Subzone boundary data. It is in ESRI shapefile format, and can be taken from https://www.data.gov.sg/.
- CostalOutline is the national boundary of Singapore. It is in ESRI shapefile format, and can taken from SLA website.

# 3 Setting Up the Environment

The following code chunk install the following packages:

- maptools to convert Spatial objects into ppp format
- sf to handle geospatial data
- raster to convert image output generate by spatstat into raster format.
- spatstat to perform 1st and 2nd-order spatial point patterns analysis and derive kernel density estimation (KDE) layer
- tmap to create choropleth maps
- tidyr to tidy messy data
- readr to import csv

```{r}
packages = c('maptools', 'sf', 'raster','spatstat', 'tmap', 'tidyr', 'readr')
for (p in packages){
  if(!require(p, character.only = T)){
    install.packages(p)
  }
  library(p,character.only = T)
}
```


# 4 Spatial Data Wrangling

## 4.1 Importing Geospatial Data 

### 4.1.1 MrtLrt

#### 4.1.1.1 Importing

The following code uses st_read function of sf package to import MrtLrt geospatial data sets.

```{r}
mrtlrt_sf <- st_read(dsn = "data/geospatial", layer="MRTLRTStnPtt")
```

The MrtLrt data have 185 features with 3 fields. The projected CRS is SVY21. The geometry type is in point. 

#### 4.1.1.2 Check CRS

Next, we use st_crs function of sf to check the CRS.

```{r}
st_crs(mrtlrt_sf)
```

From the result above, even though the mrtlrt_sf is projected in svy21, the last line indicates that the EPSG is 9001. It is wrong because the correct EPSG code for svy21 should be 3414.

#### 4.1.1.3 Assign EPSG code to a simple feature data frame

The following code chunk will assign the correct EPSG code to mrtlrt_sf using st_set_crs function of sf package

```{r}
mrtlrt_sf <- st_set_crs(mrtlrt_sf, 3414)
```

Now that we have assign the correct EPSG code to mrtlrt_sf, we will check the CRS again using st_crs function of sf

#### 4.1.1.4 Check CRS again

```{r}
st_crs(mrtlrt_sf)
```

From the result above, we have successfully assign EPSG 3414 to mrtlrt_sf.

### 4.1.2 CostalOutline

#### 4.1.2.1 Importing

The following code uses st_read function of sf package to import CostalOutline geospatial data sets.

```{r}
sg_sf <- st_read(dsn = "data/geospatial", layer="CostalOutline")
```

The CostalOutline data have 60 features with 4 fields. The projected CRS is SVY21. The geometry type is polygon.

#### 4.1.2.2 Check CRS

```{r}
st_crs(sg_sf)
```

Similarly, even though the sg_sf is projected in svy21, the last line indicates that the EPSG is 9001. It is wrong because the correct EPSG code for svy21 should be 3414.

#### 4.1.2.3 Assign EPSG code to a simple feature data frame

The following code chunk will assign the correct EPSG code to sg_sf using st_set_crs function of sf package

```{r}
sg_sf <- st_set_crs(sg_sf, 3414)
```

Now that we have assign the correct EPSG code to sg_sf, we will check the CRS again using st_crs function of sf

#### 4.1.2.4 Check CRS again

```{r}
st_crs(sg_sf)
```
We have successfully set the EPSG to 3414 for sg_sf.

### 4.1.3 MPSZ

#### 4.1.3.1 Importing
The following code uses st_read function of sf package to import MP14_SUBZONE_WEB_PL geospatial data sets.

```{r}
mpsz_sf <- st_read(dsn = "data/geospatial", layer = "MP14_SUBZONE_WEB_PL")
```

The mpsz data have 323 features with 15 fields. The projected CRS is SVY21. The geometry type is multipolygon.

#### 4.1.3.2 Check CRS

```{r}
st_crs(mpsz_sf)
```

Similarly, even though the mpsz_sf is projected in svy21, the last line indicates that the EPSG is 9001. It is wrong because the correct EPSG code for svy21 should be 3414.

#### 4.1.3.3 Assign EPSG code to a simple feature data frame

The following code chunk will assign the correct EPSG code to mpsz_sf using st_set_crs function of sf package

```{r}
mpsz_sf <- st_set_crs(mpsz_sf, 3414)
```

Now that we have assign the correct EPSG code to mpsz_sf, we will check the CRS again using st_crs function of sf

#### 4.1.3.4 Check CRS again

```{r}
st_crs(mpsz_sf)
```

We have successfully assign ESPG 3414 to mpsz_sf.

## 4.2 Importing Aspatial Data 

### 4.2.1 Hotel

#### 4.2.1.1 Importing

The following code uses read_csv function of readr package to import Hotel aspatial data sets.

```{r}
hotels <- read_csv("data/aspatial/hotels.csv")
```

#### 4.2.1.2 Examine the file

The following code uses list function of base R to examine the imported file

```{r}
list(hotels)
```

The data contains 422 rows and 9 columns. There are 'Lat' and 'Lng' column for coordinates. They are in decimal degree format, hence we will assume the data is wgs84.

We will next check if there are any NA value in 'Lat' and 'Lng' using is.na function of base R package.

```{r}
any(is.na(hotels$Lat))
```

```{r}
any(is.na(hotels$Lng))
```

We can confirmed that there are no NA values and we can proceed to create a simple feature data frame.

#### 4.2.1.3 Create simple feature data frame from aspatial data

The following code 
1. convert hotels data  into simple feature data frame using st_as_sf feature of sf package.
2. 'Lng' and 'Lat' column are set as the coords arguments.
3. CRS were set as 4326 since we assumed that the data is wgs84
4. st_transform function of sf package then helps to transform the newly created simple feature data frame into svy21
5. tm_shape and tm_dots function of tmap plots the transformed hotels_sf

```{r}
hotels_sf <- st_as_sf(hotels,
                    coords = c("Lng", 
                               "Lat"),
                    crs=4326) %>%
  st_transform(crs = 3414)

tm_shape(hotels_sf)+
  tm_dots()
```

### 4.2.2 Tourism

#### 4.2.2.1 Importing

The following code uses read_csv function of readr package to import Tourism aspatial data sets.

```{r}
tourism <- read_csv("data/aspatial/tourism.csv")
```

#### 4.2.2.2 Examine the file

The following code uses list function of base R to examine the imported file

```{r}
list(tourism)
```

The tourism data contains 107 rows and 17 columns. There are 'LATITUDE' and 'LONGTITUDE' column, as well as 'Lat' and 'Lng' coluumn for coordinates. We will be using 'LATITUDE' and 'LONGTITUDE' column since they are the same. They are in decimal degree format, hence we will assume the data is wgs84.

We will next check if there are any NA value in 'LATITUDE' and 'LONGTITUDE' using is.na function of base R package.

```{r}
any(is.na(tourism$LATITUDE))
```

```{r}
any(is.na(tourism$LATITUDE))
```

There are NA values and we will need to drop them before creating a simple feature data frame.

The following code chunk drop rows of data as long as the LATITUDE is NA.

```{r}
tourism <- tourism %>%
            drop_na("LATITUDE")
```


#### 4.2.2.3 Create simple feature data frame from aspatial data

The following code 
1. convert tourism data into simple feature data frame using st_as_sf feature of sf package.
2. 'LONGTITUDE' and 'LATITUDE' column are set as the coords arguments. 
3. CRS were set as 4326 since we assumed that the data is wgs84
4. st_transform function of sf package then helps to transform the newly created simple feature data frame into svy21
5. tm_shape and tm_dots function of tmap plots the transformed tourism_sf

```{r}

tourism_sf <- st_as_sf(tourism,
                    coords = c("LONGTITUDE", 
                               "LATITUDE"),
                    crs=4326) %>%
  st_transform(crs = 3414)

tm_shape(tourism_sf)+
  tm_dots()
```

### 4.2.3 Airbnb0619

#### 4.2.3.1 Importing

The following code uses read_csv function of readr package to import Airbnb listings30062019.csv aspatial data sets.

```{r}
airbnb0619 <- read_csv("data/aspatial/listings30062019.csv")
```

#### 4.2.3.2 Examine the file

The following code uses list function of base R to examine the imported file

```{r}
list(airbnb0619)
```

The airbnb0619 data contains 8293 rows and 16 columns. There are 'latitude' and 'longitude' column for coordinates. They are in decimal degree format, hence we will assume the data is wgs84.

We will next check if there are any NA value in 'latitude' and 'longitude' using is.na function of base R package.

```{r}
any(is.na(airbnb0619$latitude))
```

```{r}
any(is.na(airbnb0619$longitude))
```

Since there are no NA values, we can proceed to create simple features data frame for airbnb0619

#### 4.2.3.3 Create simple feature data frame from aspatial data

The following code 
1. convert airbnb0619 data into simple feature data frame using st_as_sf feature of sf package.
2. 'longitude' and 'latitude' column are set as the coords arguments. 
3. CRS were set as 4326 since we assumed that the data is wgs84
4. st_transform function of sf package then helps to transform the newly created simple feature data frame into svy21
5. tm_shape and tm_dots function of tmap plots the transformed airbnb0619_sf

```{r}
airbnb0619_sf <- st_as_sf(airbnb0619,
                    coords = c("longitude", 
                               "latitude"),
                    crs=4326) %>%
  st_transform(crs = 3414)

tm_shape(airbnb0619_sf)+
  tm_dots()
```

### 4.2.4 Airbnb0721

#### 4.2.4.1 Importing

The following code uses read_csv function of readr package to import Airbnb listings19072021.csv aspatial data sets.

```{r}
airbnb0721 <- read_csv("data/aspatial/listings19072021.csv")
```

#### 4.2.4.2 Examine the file

The following code uses list function of base R to examine the imported file

```{r}
list(airbnb0721)
```

The airbnb0721 data contains 4252 rows and 16 columns, lesser than airbnb0619. There are 'latitude' and 'longitude' column for coordinates. They are in decimal degree format, hence we will assume the data is wgs84.

We will next check if there are any NA value in 'latitude' and 'longitude' using is.na function of base R package.

```{r}
any(is.na(airbnb0721$latitude))
```

```{r}
any(is.na(airbnb0721$longitude))
```

We can confirm that there are no latitude and longitude with NA value.

#### 4.2.4.3 Create simple feature data frame from aspatial data

The following code 
1. convert airbnb0721 data into simple feature data frame using st_as_sf feature of sf package.
2. 'longitude' and 'latitude' column are set as the coords arguments. 
3. CRS were set as 4326 since we assumed that the data is wgs84
4. st_transform function of sf package then helps to transform the newly created simple feature data frame into svy21
5. tm_shape and tm_dots function of tmap plots the transformed airbnb0721_sf

```{r}
airbnb0721_sf <- st_as_sf(airbnb0721,
                    coords = c("longitude", 
                               "latitude"),
                    crs=4326) %>%
  st_transform(crs = 3414)

tm_shape(airbnb0721_sf)+
  tm_dots()
```

## 4.3 Geospatial Data wrangling

After importing geospatial and aspatial data, we will convert the simple feature data frame to sp’s Spatial* class.

### 4.3.1 Converting sf data frames to sp’s Spatial* class

The following code chunk converts all the geospatial data from simple feature data frame to sp’s Spatial* class using as_Spatial functions of sf package.

```{r}
airbnb0619 <- as_Spatial(airbnb0619_sf)
airbnb0721 <- as_Spatial(airbnb0721_sf)
hotels <- as_Spatial(hotels_sf)
tourism <- as_Spatial(tourism_sf)
mrtlrt <- as_Spatial(mrtlrt_sf)
sg <- as_Spatial(sg_sf)
mpsz <- as_Spatial(mpsz_sf)
```

Check each Spatial* class

```{r}
airbnb0619
```

```{r}
airbnb0721
```

```{r}
hotels
```

```{r}
tourism
```

```{r}
mrtlrt
```

```{r}
sg
```

```{r}
mpsz
```

We can see that all the geospatial data are converted to their respective Spatial* Classes.

### 4.3.2 Converting the Spatial* class into generic sp format



```{r}
airbnb0619_sp <- as(airbnb0619, "SpatialPoints")
airbnb0721_sp <- as(airbnb0721, "SpatialPoints")
hotels_sp <- as(hotels, "SpatialPoints")
tourism_sp <- as(tourism, "SpatialPoints")
mrtlrt_sp <- as(mrtlrt, "SpatialPoints")
sg_sp <- as(sg, "SpatialPolygons")
mpsz_sp <- as(mpsz, "SpatialPolygons")
```

### 4.3.3 Converting the generic sp format into spatstat’s ppp format

```{r}
airbnb0619_ppp <- as(airbnb0619_sp, "ppp")
airbnb0721_ppp <- as(airbnb0721_sp, "ppp")
hotels_ppp <- as(hotels_sp, "ppp")
tourism_ppp <- as(tourism_sp, "ppp")
mrtlrt_ppp <- as(mrtlrt_sp, "ppp")
```

### 4.3.4 Check for duplicates in ppp object

```{r}
any(duplicated(airbnb0619_ppp))
```

```{r}
any(duplicated(airbnb0721_ppp))
```

```{r}
any(duplicated(hotels_ppp))
```

```{r}
any(duplicated(tourism_ppp))
```

```{r}
any(duplicated(mrtlrt_ppp))
```

We can see that ...

Handling duplicates using jittering.

Jittering will add a small perturbation to the duplicate points so that they do not occupy the exact same space.

```{r}
airbnb0619_ppp_jit <- rjitter(airbnb0619_ppp, 
                             retry=TRUE, 
                             nsim=1, 
                             drop=TRUE)

airbnb0721_ppp_jit <- rjitter(airbnb0721_ppp, 
                             retry=TRUE, 
                             nsim=1, 
                             drop=TRUE)

hotels_ppp_jit <- rjitter(hotels_ppp, 
                             retry=TRUE, 
                             nsim=1, 
                             drop=TRUE)

tourism_ppp_jit <- rjitter(tourism_ppp, 
                             retry=TRUE, 
                             nsim=1, 
                             drop=TRUE)
```

Check if duplicates still exist

```{r}
any(duplicated(airbnb0619_ppp_jit))
```

```{r}
any(duplicated(airbnb0721_ppp_jit))
```

```{r}
any(duplicated(hotels_ppp_jit))
```

```{r}
any(duplicated(tourism_ppp_jit))
```

### 4.3.5 creating owin objects

```{r}
sg_owin <- as(sg_sp, "owin")
mpsz_owin <- as(mpsz_sp, "owin")
```

```{r}
plot(sg_owin)
```

```{r}
plot(mpsz_owin)
```

### 4.3.6 Combining point events object and owin object

```{r}
airbnb0619SG_ppp = airbnb0619_ppp_jit[sg_owin]
airbnb0721SG_ppp = airbnb0721_ppp_jit[sg_owin]
hotelsSG_ppp = hotels_ppp_jit[sg_owin]
tourismSG_ppp = tourism_ppp_jit[sg_owin]
mrtlrtSG_ppp = mrtlrt_ppp[sg_owin]
```

```{r}
airbnb0619SG_ppp1 = airbnb0619_ppp_jit[mpsz_owin]
airbnb0721SG_ppp1 = airbnb0721_ppp_jit[mpsz_owin]
hotelsSG_ppp1 = hotels_ppp_jit[mpsz_owin]
tourismSG_ppp1 = tourism_ppp_jit[mpsz_owin]
mrtlrtSG_ppp1 = mrtlrt_ppp[mpsz_owin]
```

```{r}
plot(airbnb0619SG_ppp)
```

```{r}
plot(airbnb0619SG_ppp1)
```

# Section A: Airbnb Distribution in 2019

## 1. Exploratory Spatial Data Analysis

### Kernel density maps

#### Airbnb listings

```{r}
airbnb0619SG_ppp.km <- rescale(airbnb0619SG_ppp, 1000, "km")

kde_airbnb0619SG_600 <- density(airbnb0619SG_ppp.km, sigma=0.6, edge=TRUE, kernel="gaussian")

plot(kde_airbnb0619SG_600)
```

```{r}
airbnb0721SG_ppp.km <- rescale(airbnb0721SG_ppp, 1000, "km")

kde_airbnb0721SG_ppp_bw <- density(airbnb0721SG_ppp.km,
                              sigma=bw.diggle,
                              edge=TRUE,
                            kernel="gaussian") 

plot(kde_airbnb0721SG_ppp_bw)
```

#### Hotels

```{r}
hotels_ppp.km <- rescale(hotelsSG_ppp, 1000, "km")

kde_hotelsSG_600 <- density(hotels_ppp.km, sigma=0.6, edge=TRUE, kernel="gaussian")

plot(kde_hotelsSG_600)
```

#### MRT

```{r}
mrtlrt_ppp.km <- rescale(mrtlrtSG_ppp, 1000, "km")

kde_mrtlrtSG_600 <- density(mrtlrt_ppp.km, sigma=0.6, edge=TRUE, kernel="gaussian")

plot(kde_mrtlrtSG_600)
```

#### Tourist Attractions

```{r}
tourism_ppp.km <- rescale(tourismSG_ppp, 1000, "km")

kde_tourismSG_600 <- density(tourism_ppp.km, sigma=0.6, edge=TRUE, kernel="gaussian")

plot(kde_tourismSG_600)
```

### Kernel density maps on openstreetmap of Singapore


## 2. Second-order Spatial Point Patterns Analysis

### Null hypothesis and alternative hypothesis

### Test

### Statistical conclusions.

# Section B: Impact of COVID-19

## 3. Exploratory Spatial Data Analysis

## 4. Second-order Spatial Point Patterns Analysis
